# ==============================================================================
### **【公式版】 `takumi-comfyui` 要件定義書 v1.0**
# ==============================================================================

#### **1. プロジェクト概要 (Executive Summary)**

*   **1.1. プロジェクト名:**
    *   `takumi-comfyui`
*   **1.2. プロジェクト・フィロソフィー:**
    *   **『The Takumi's Concierge (匠のコンシェルジュ)』**思想に基づき、ComfyUIの複雑な環境構築を、**ユーザーの「目的」から逆算する対話型の体験**へ変革する。ユーザーを依存関係地獄から解放し、創造的活動に集中させることを唯一の目的とする。
*   **1.3. ターゲットユーザー:**
    *   ComfyUIを始めたいが、Python環境構築や依存関係解決に不慣れな**プログラミング初学者**。
*   **1.4. 解決すべき核心的課題:**
    *   カスタムノードの組み合わせによって生じる、C++ビルドエラーやライブラリ衝突といった**「環境構築の壁」**を、ユーザーから完全に抽象化（隠蔽）する。

---

#### **2. システムアーキテクチャ原則 (Architectural Principles)**

本システムは、`GraphAI`の思想に啓発された、以下の`takumi`憲法の原則に従って設計される。

*   **2.1. アーキテクチャ原則 (Principles):**
    *   **AP-1: 宣言的なワークフロー定義:**
        *   インストールプロセスは、`YAML`形式の**レシピファイル（データ）**によって宣言的に定義される。
    *   **AP-2: ノードベースの抽象化:**
        *   インストールを構成する各ステップ（OS判定、ビルドツール確認等）は、独立・再利用可能な**「ノード（関数）」**として実装される。
    *   **AP-3: データと実行エンジンの分離:**
        *   レシピファイル（設計図）と、それを解釈・実行するインストーラースクリプト（実行エンジン）は、完全に分離される。

*   **2.2. 実行環境 (Execution Environment):**
    *   **EE-1: Dockerによる環境の強制:**
        *   本システムは、**Dockerコンテナ内**での実行を前提とする。これにより、OSやビルドツールといった環境依存の問題を完全に排除し、全ユーザーに100%同一の、安定した実行基盤を提供する。
        *   OS判定、ビルドツール導入、GPU基盤構築（Conda/MambaによるPyTorchインストール）は、全て**`Dockerfile`**によって宣言的に定義される。

---

#### **3. 機能要件 (Functional Requirements)**

##### **FR-1: 対話型コンシェルジュ (`The Takumi's Concierge`)**
*   *ユーザーとの全ての対話的インターフェースを担うモジュール。*
*   **FR-1.1: ユースケース・ヒアリング:** `make install`実行時、ユーザーに「写真風」「アニメ風」といった平易なユースケースを選択させる。
*   **FR-1.2: トレードオフの提示と確認:** 選択されたユースケースに基づき、「`pixeloe`は高品質だが、一部機能と競合する可能性があるため除外します」といった、`takumi`の知見に基づくトレードオフを提示し、ユーザーの同意を得る。
*   **FR-1.3: 実行計画の提示:** インストール開始前に、実行するタスクの概要を専門用語を避けて提示し、最終確認を求める。

##### **FR-2: 宣言的パッケージマネージャー (`FAIR Package Manager`)**
*   *コンシェルジュからの指示に基づき、実際のインストール処理を担う実行エンジン。*
*   **FR-2.1: レシピ駆動の実行:**
    -   インストール構成は、`usecase_recipes.yml`（成功パターン）と`error_recipes.yml`（失敗パターン）によって宣言的に定義される。
*   **FR-2.2: ノード化されたインストール順序制御:** `install.sh`は、レシピの指示に従い、以下の**ノード**を**正しい順序で**実行する。
    1.  **一括インストールノード:** 選択されたカスタムノード群の`requirements.txt`を統合し、`pip`で一括インストール。
    2.  **要注意インストールノード:** レシピで「環境を破壊する危険性がある」と定義されたライブラリ（`kornia`等）を、`pip`で**最後に**インストール。
*   **FR-2.3: 構造化ログ出力:** 各ノードの実行成否を明確に記録した、構造化ログを出力する。

##### **FR-3: 階層的エラー解決 (`Self-Healing Mechanism`)**
*   *インストール失敗時に、段階的に解決を試みる自己修復機能。*
*   **FR-3.1: エラー検知:** インストールプロセス失敗時、異常終了コードを検知する。
*   **FR-3.2: レベル1解決 (ルールベース):** まず、`error_recipes.yml`に基づき、エラーログをキーワードで照合し、**既知の問題であれば、検証済みの解決策**を提示する。
*   **FR-3.3: レベル2解決 (SLM支援):** レベル1で解決できない**未知のエラー**の場合、ユーザーに確認の上、Dockerコンテナ内で**SLM (`Gemma3`)**を起動する。SLMは、エラーログと現在のコンテキストを分析し、**解決策のヒント**を提案する。
*   **FR-3.4: 制御された試行 (Controlled Trial):**
    -   ユーザーは、提案された解決策を**一度**試行することを選択できる。
    -   この試行は、完全に独立したクリーンな環境（新しいDockerコンテナ）で実行される。
*   **FR-3.5: 反復的再挑戦 (Iterative Retry):**
    -   試行が再度失敗した場合、ユーザーは**再挑戦**を選択できる。
    -   再挑戦時、システムは過去の試行履歴（`install_history`）をSLMに渡し、**前回とは異なる、より有望な解決策**を提示するよう促す。
*   **FR-3.6: `takumi`へのエスカレーション:** SLMでも解決できない場合、ユーザーに最終確認の上、詳細な構造化ログを`The Takumi's Logbook`に送信する。

##### **FR-4: 集合知データベース (`The Takumi's Logbook`)**
*   **FR-4.1: 匿名ログの生成:** インストール成功時、環境情報、選択ユースケース等を含む**JSON形式の匿名ログ**を生成する。
*   **FR-4.2: 同意に基づくデータ収集:** ユーザーの同意を得た上で、**AWSサーバーレス基盤（API Gateway -> Lambda -> S3）**へ、匿名ログをHTTPS経由で送信する。
*   **FR-4.3: プライベートなデータレイク:** 収集されたログは、**プライベートなS3バケット**に蓄積され、第三者がアクセスすることはできない。

---

#### **4. 非機能要件 (Non-Functional Requirements)**

*   **NFR-1: 使いやすさ (Usability):** ユーザーは`make install`一発で、全てのプロセスがガイドされる。
*   **NFR-2: 拡張性 (Extensibility):** 新しい知見は`recipes.yml`に追記するだけで、システムが賢くなる。
*   **NFR-3: 移植性 (Portability):** 主要OS（Windows/macOS/Linux）をサポートする。
*   **NFR-4: コスト (Cost):** ユーザー向けの機能は、APIコール等の**追加コストを一切要求しない。**

---

#### **5. 将来的な拡張要件 (Future Vision - Out of Scope for v1.0)**

*   **FV-1: MLによる自己修復 (`The Collective Intelligence`):**
    *   S3に蓄積されたログデータを学習データとし、**GBDT**や**ベイズ最適化**（Optuna等）を用いて、**最適なインストール組み合わせを推薦するMLモデル**を構築する。
    *   このモデル開発のための**初期データ**は、開発者がGrok等で収集した失敗パターンを、**Dockerベースの自動テスト環境 (`make test`)**で再現・収集することにより生成する。
*   **FV-2: ワークフローの宣言的管理:**
    *   インストールだけでなく、ComfyUIの**実行ワークフロー**自体も、`GraphAI`の思想に基づき、宣言的なデータ（テンプレート）として提供する。
*   **FV-3: 汎用エージェント基盤への進化:**
    *   このインストーラーのアーキテクチャを、ComfyUI以外のAIツール（`kohya_ss`等）や、汎用AIエージェントのセットアップにも応用可能な、**`takumi-core`**へと昇華させる。
*   **FV-4: 自己進化するレシピブック (`Self-Evolving Recipe Book`):**
    *   システムは、`The Takumi's Logbook` (FR-4) によってS3データレイクに蓄積された**膨大なインストールログ**を、`The Collective Intelligence` (FV-1) の**MLモデル**で定期的に分析する、自動化されたパイプラインを持たなければならない。
    *   このパイプラインは、分析結果に基づき、**`usecase_recipes.yml`** と **`error_recipes.yml`** (FR-1.2) を**改善するための具体的な変更案（Pull Requestの差分形式など）**を、**自動で生成**しなければならない。
    *   開発者（あなた）は、AIが提案した変更案を**レビューし、承認するだけ**で、世界中のユーザーの集合知を、システムのルールブックへと還元できる。

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

・ブラウザ上でコピペができない
・インストールの自動化をしたいです（cliの操作をユーザーに求めるの現実的ではない）
・インストール先のリスト化

・現在の複雑なケースに対応できるようにしたい